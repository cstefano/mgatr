# Migratonator - Database Migration Tool

[![.NET](https://github.com/cstefano/mgatr/actions/workflows/dotnet.yml/badge.svg)](https://github.com/cstefano/mgatr/actions/workflows/dotnet.yml)

_`Migrate - toe - nater`_  (_`EM gatt err`_ for short)

> CLI Tool for managing MSSQL Database schemas, objects and data.

Built to leverage the excellent [DbUp](https://dbup.github.io/) library, `Migratonator` adds
support for managing variables, migration files, running scripts for views and stored procedures,
adds support for SQL CLR Assemblies and the use of macros in scripts.

## Concepts

The tool is opinionated such that:

* a specific directory structure is assumed,
* the order in which changes are applied is deterministic,
* changes which affect the data, such as to types, tables and indexes, must be made using migrations,
* changes to all other objects, such as views, functions and procedures must be scripted in an idempotent way,
* data seeds must be scripted in an idempotent way,
* a `Schema.sql` file is generated to represent the most current version of the database schema.

### Directory Structure

The directory structure and base files are as follows.

```
Project Root Directory
  ∟ Assemblies
    - Assembly.sql
    - ...
  ∟ Functions
    - Function.sql
    - ...
  ∟ Jobs
    - Job.sql
    - ...
  ∟ Migrations
    - 0001-Migration1.sql
    - 0002-Migration2.sql
    - ...
    - 9999-Migration999.sql
  ∟ Procedures
    - Procedure.sql
    - ...
  ∟ Seeds
    - Seed.sql
    - ...
  ∟ Views
    - View.sql
    - ...
  - Schema.sql
  - Variables.json
  - Macros.json
```

### Execution

The order in which schema, object and data changes are be made in the following order.

1. Migrations
1. Assemblies
1. Functions
1. Procedures
1. Views
1. Jobs
1. Seeds

### Migrations

Scripts within the `Migrations` directory will only be executed once, whereas _all_ other
scripts will be executed each time and therefore must be implemented to be _idempotent_.

Furthermore, scripts within the `Migrations` directory _must only_ be used to manage objects
which hold or where there are hard dependencies.

Examples include:

* creating types,
* creating tables,
* modifying columns,
* modifying constraints, indexes,
* and dropping existing objects.

By following this convention, dependencies between scripts can be managed deterministically.

### Scripts

### `Schema.sql`

The `Schema.sql` file is generated by the tool each time a command which effects a change is run.

It is used to recreate the database for the current version, and should be checked into source code
control after migrations and scripts have been applied in the development environment.

The updated `Schema.sql` file should be included together with the corresponding migrations as
part of a pull request, so that the full extent of the change can understood by the reviewer.

### Variables

Scripts can contain variables which get replaced when the migrations are prepared.

Use the format `$VariableName$` to denote a variable in the scripts and provide the
corresponding named entries in the `Variables.json` file.

E.g. Given a script which creates a user role:

```sql
CREATE LOGIN [$DomainName$\$UserName$]
FROM WINDOWS
;

GO
```

And the variables JSON file contents:

```json
[
  {
    "Name": "DomainName",
    "Value": "SOMEDOMAIN"
  },
  {
    "Name": "UserName",
    "Value": "Bob"
  }
]
```

The rendered script would be as follows:

```sql
CREATE LOGIN [SOMEDOMAIN\Bob]
FROM WINDOWS
;

GO
```

### SQL CLR Assemblies

_To be completed_

### Macros

Macros are provided via the `Macros.json` file. Macros are inserted into scripts using
the `/* %Macro:Name[Parameter1|Parameter2|...|ParameterN%] */` syntax.

E.g. Psuedo T-SQL code for a hypothetical `OBJECT` type.

```sql
-- %Macro:DropObjectIfExist[ObjectName]%

CREATE OBJECT ObjectName AS
...
```

When migrations or scripts are applied, the macros are replaced with the respective
templated content before execution.

## Pre-requisites

* [DotNet Core][dotnet]
* [`DbUp` Library][dbup]
* [`System.CommandLine` Library][cmdline]
* [`Microsoft.SqlServer.SqlManagementObjects` Library][smo]

## Usage

See [commands](COMMANDS.md) for the commandline reference.

## Hacking

### Building

Build the tool using the `dotnet` command line tool.

```bash
dotnet build
```

### Testing

Test the tool using the `dotnet` command line tool.

```bash
dotnet test
```

### Running

Run the tool with the `--help` flag to see the available options.

```bash
mgatr --help
```

## License

[MIT License](LICENSE) Copyright (c) Chris Stefano

<!-- links -->

[cmdline]: https://www.nuget.org/packages/System.CommandLine
[dbup]: https://github.com/DbUp/DbUp
[dotnet]: https://dotnet.microsoft.com/download
[smo]: https://www.nuget.org/packages/Microsoft.SqlServer.SqlManagementObjects
